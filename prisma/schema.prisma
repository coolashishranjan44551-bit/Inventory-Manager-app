// Prisma schema aligning with Supabase Postgres tables.
// Update migrations in Supabase separately; Prisma client is used for typed access.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  owner
  manager
  staff
}

enum StockEntryType {
  purchase
  sale
  adjustment
  wastage
  transfer
}

enum PurchaseOrderStatus {
  draft
  ordered
  received
  cancelled
}

enum OrderType {
  dine_in   @map("dine-in")
  takeaway
  delivery
}

enum OrderStatus {
  open
  paid
  cancelled
  void
}

enum PaymentMethod {
  cash
  card
  upi
  wallet
  razorpay
}

model Organization {
  id             String              @id @default(uuid()) @db.Uuid
  name           String
  gstin          String?             @db.Text
  address        Json?
  currency       String              @default("INR")
  upiQrUrl       String?             @map("upi_qr_url")
  razorpayKey    String?             @map("razorpay_key")
  razorpaySecret String?             @map("razorpay_secret")
  createdAt      DateTime            @default(now()) @map("created_at")

  members        OrganizationUser[]
  suppliers      Supplier[]
  products       Product[]
  menus          Menu[]
  tables         CafeTable[]
  orders         Order[]
  payments       Payment[]
  stockLedger    StockLedger[]
  purchaseOrders PurchaseOrder[]
  reports        ReportCache[]
  auditLogs      AuditLog[]

  @@map("organizations")
}

model User {
  id         String              @id @db.Uuid
  email      String              @unique
  fullName   String?             @map("full_name")
  createdAt  DateTime            @default(now()) @map("created_at")

  memberships OrganizationUser[]
  createdOrders Order[]          @relation("OrderCreatedBy")
  closedOrders  Order[]          @relation("OrderClosedBy")
  stockEntries  StockLedger[]    @relation("StockCreatedBy")
  payments      Payment[]        @relation("PaymentReceivedBy")
  auditLogs     AuditLog[]

  @@map("users")
}

model OrganizationUser {
  id         String    @id @default(uuid()) @db.Uuid
  orgId      String    @map("org_id") @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  role       UserRole
  invitedAt  DateTime  @default(now()) @map("invited_at")
  acceptedAt DateTime? @map("accepted_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@map("organization_users")
}

model Supplier {
  id        String    @id @default(uuid()) @db.Uuid
  orgId     String    @map("org_id") @db.Uuid
  name      String
  contact   Json?
  gstin     String?   @db.Text
  createdAt DateTime  @default(now()) @map("created_at")

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model Product {
  id                 String            @id @default(uuid()) @db.Uuid
  orgId              String            @map("org_id") @db.Uuid
  sku                String?           @db.Text
  barcode            String?           @db.Text
  name               String
  category           String?           @db.Text
  unit               String            @default("pcs")
  price              Decimal           @db.Decimal(10, 2)
  costPrice          Decimal?          @map("cost_price") @db.Decimal(10, 2)
  gstRate            Decimal?          @map("gst_rate") @db.Decimal(5, 2)
  trackStock         Boolean           @map("track_stock") @default(true)
  lowStockThreshold  Decimal?          @map("low_stock_threshold") @db.Decimal(12, 2)
  isActive           Boolean           @map("is_active") @default(true)
  createdAt          DateTime          @default(now()) @map("created_at")

  organization       Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  variants           ProductVariant[]
  stockLedgerEntries StockLedger[]
  orderItems         OrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  menuItems          MenuItem[]

  @@map("products")
}

model ProductVariant {
  id            String    @id @default(uuid()) @db.Uuid
  productId     String    @map("product_id") @db.Uuid
  name          String?
  price         Decimal?  @db.Decimal(10, 2)
  costPrice     Decimal?  @map("cost_price") @db.Decimal(10, 2)
  additionalData Json?    @map("additional_data")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("product_variants")
}

model StockLedger {
  id         String         @id @default(uuid()) @db.Uuid
  orgId      String         @map("org_id") @db.Uuid
  productId  String         @map("product_id") @db.Uuid
  quantity   Decimal        @db.Decimal(12, 2)
  balance    Decimal        @db.Decimal(12, 2)
  type       StockEntryType
  referenceId String?       @map("reference_id") @db.Uuid
  note       String?        @db.Text
  createdById String?       @map("created_by") @db.Uuid
  createdAt   DateTime      @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("StockCreatedBy", fields: [createdById], references: [id])

  @@map("stock_ledger")
}

model PurchaseOrder {
  id          String                 @id @default(uuid()) @db.Uuid
  orgId       String                 @map("org_id") @db.Uuid
  supplierId  String?                @map("supplier_id") @db.Uuid
  status      PurchaseOrderStatus    @default(draft)
  expectedDate DateTime?             @map("expected_date")
  totalAmount  Decimal?              @map("total_amount") @db.Decimal(12, 2)
  gstAmount    Decimal?              @map("gst_amount") @db.Decimal(12, 2)
  createdById  String?               @map("created_by") @db.Uuid
  createdAt    DateTime              @default(now()) @map("created_at")

  organization Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  supplier     Supplier?      @relation(fields: [supplierId], references: [id])
  createdBy    User?          @relation(fields: [createdById], references: [id])
  items        PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String        @id @default(uuid()) @db.Uuid
  purchaseOrderId  String        @map("purchase_order_id") @db.Uuid
  productId        String?       @map("product_id") @db.Uuid
  quantity         Decimal?      @db.Decimal(12, 2)
  costPrice        Decimal?      @map("cost_price") @db.Decimal(10, 2)
  gstRate          Decimal?      @map("gst_rate") @db.Decimal(5, 2)
  lineTotal        Decimal?      @map("line_total") @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product?      @relation(fields: [productId], references: [id])

  @@map("purchase_order_items")
}

model Menu {
  id        String     @id @default(uuid()) @db.Uuid
  orgId     String     @map("org_id") @db.Uuid
  name      String?
  isActive  Boolean    @map("is_active") @default(true)
  createdAt DateTime   @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  items        MenuItem[]

  @@map("menus")
}

model MenuItem {
  id          String   @id @default(uuid()) @db.Uuid
  menuId      String   @map("menu_id") @db.Uuid
  productId   String?  @map("product_id") @db.Uuid
  displayName String?  @map("display_name")
  sortOrder   Int?     @map("sort_order")
  isAvailable Boolean  @map("is_available") @default(true)

  menu    Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("menu_items")
}

model CafeTable {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  name      String
  capacity  Int?
  isActive  Boolean  @map("is_active") @default(true)

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@map("tables")
}

model Order {
  id            String        @id @default(uuid()) @db.Uuid
  orgId         String        @map("org_id") @db.Uuid
  tableId       String?       @map("table_id") @db.Uuid
  orderNumber   Int?          @map("order_number")
  orderType     OrderType     @default(dine_in)
  status        OrderStatus   @default(open)
  subtotal      Decimal?      @db.Decimal(12, 2)
  gstAmount     Decimal?      @map("gst_amount") @db.Decimal(12, 2)
  discount      Decimal?      @db.Decimal(12, 2)
  serviceCharge Decimal?      @map("service_charge") @db.Decimal(12, 2)
  totalAmount   Decimal?      @map("total_amount") @db.Decimal(12, 2)
  paymentMode   String?       @map("payment_mode")
  paymentReference String?    @map("payment_reference")
  kotNotes      String?       @map("kot_notes") @db.Text
  createdById   String?       @map("created_by") @db.Uuid
  closedById    String?       @map("closed_by") @db.Uuid
  openedAt      DateTime      @default(now()) @map("opened_at")
  closedAt      DateTime?     @map("closed_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  table        CafeTable?    @relation(fields: [tableId], references: [id])
  createdBy    User?         @relation("OrderCreatedBy", fields: [createdById], references: [id])
  closedBy     User?         @relation("OrderClosedBy", fields: [closedById], references: [id])
  items        OrderItem[]
  payments     Payment[]

  @@map("orders")
}

model OrderItem {
  id         String        @id @default(uuid()) @db.Uuid
  orderId    String        @map("order_id") @db.Uuid
  productId  String?       @map("product_id") @db.Uuid
  variantId  String?       @map("variant_id") @db.Uuid
  quantity   Decimal?      @db.Decimal(10, 2)
  price      Decimal?      @db.Decimal(10, 2)
  gstRate    Decimal?      @map("gst_rate") @db.Decimal(5, 2)
  notes      String?       @db.Text

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product?       @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Payment {
  id          String        @id @default(uuid()) @db.Uuid
  orgId       String        @map("org_id") @db.Uuid
  orderId     String?       @map("order_id") @db.Uuid
  amount      Decimal       @db.Decimal(12, 2)
  method      PaymentMethod
  reference   String?       @db.Text
  receivedAt  DateTime      @default(now()) @map("received_at")
  receivedById String?      @map("received_by") @db.Uuid

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  order        Order?       @relation(fields: [orderId], references: [id])
  receivedBy   User?        @relation("PaymentReceivedBy", fields: [receivedById], references: [id])

  @@map("payments")
}

model ReportCache {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  reportDate  DateTime @map("report_date")
  type        String
  payload     Json?
  generatedAt DateTime @default(now()) @map("generated_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("reports_cache")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String
  entity     String
  entityId   String?  @map("entity_id") @db.Uuid
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}
